<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: page(title=${name}, content=~{::main})}">
<main>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-2">
            <h1 th:text="${name}" class="mb-0">Release Name</h1>
            <button type="button" class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal" data-bs-target="#editReleaseModal">
                Edit
            </button>
        </div>
        <div>
            <a th:href="@{/labels/{labelId}(labelId=${labelId})}"
               class="btn btn-outline-secondary">Back to Label</a>
            <form th:action="@{/labels/{labelId}/releases/{releaseId}(labelId=${labelId}, releaseId=${releaseId})}"
                  method="post"
                  class="d-inline"
                  onsubmit="return confirm('Delete this release and all its tracks?');">
                <input type="hidden" name="_method" value="delete">
                <button type="submit" class="btn btn-outline-danger">Delete</button>
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-3">Artists</dt>
                <dd class="col-sm-9" th:text="${#strings.listJoin(artists.![artistName], ', ')}">Artist Names</dd>

                <dt class="col-sm-3">Release Date</dt>
                <dd class="col-sm-9" th:text="${releaseDate}">2024-01-01</dd>

                <dt class="col-sm-3">Formats</dt>
                <dd class="col-sm-9">
                    <span th:each="format : ${formats}" class="badge bg-primary me-1" th:text="${format}">Format</span>
                    <span th:if="${#sets.isEmpty(formats)}" class="text-muted">No formats specified</span>
                </dd>
            </dl>
        </div>
    </div>

    <h2 class="h4 mb-3">Tracks</h2>
    <div class="card">
        <div class="card-body p-0">
            <table class="table table-striped mb-0">
                <thead>
                    <tr>
                        <th scope="col" style="width: 50px">#</th>
                        <th scope="col">Artist</th>
                        <th scope="col">Title</th>
                        <th scope="col" style="width: 80px">Duration</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="track : ${tracks}">
                        <td th:text="${track.position()}">1</td>
                        <td th:text="${#strings.listJoin(track.artists().![artistName], ', ')}">Artist Name</td>
                        <td th:text="${track.name()}">Track Name</td>
                        <td th:text="${track.duration().formatted()}">3:30</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex align-items-center gap-2 mt-4 mb-3">
        <h2 class="h4 mb-0">Costs</h2>
        <button type="button" class="btn btn-outline-primary btn-sm"
                data-bs-toggle="modal" data-bs-target="#addCostModal">+</button>
    </div>
    <div class="card mb-4">
        <div class="card-body p-0">
            <table class="table table-striped mb-0" th:if="${!costs.isEmpty()}">
                <thead>
                    <tr>
                        <th scope="col">Date</th>
                        <th scope="col">Type</th>
                        <th scope="col">Description</th>
                        <th scope="col" class="text-end">Net</th>
                        <th scope="col" class="text-end">VAT</th>
                        <th scope="col" class="text-end">Gross</th>
                        <th scope="col">Document</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="cost : ${costs}">
                        <td th:text="${cost.incurredOn()}">2024-01-01</td>
                        <td th:text="${cost.type()}">MASTERING</td>
                        <td th:text="${cost.description()}">Description</td>
                        <td class="text-end" th:text="${cost.netAmount().amount()} + ' ' + ${cost.netAmount().currency()}">100.00 EUR</td>
                        <td class="text-end" th:text="${cost.vat().amount().amount()} + ' (' + ${#numbers.formatPercent(cost.vat().rate(), 1, 0)} + ')'">25.00 (25%)</td>
                        <td class="text-end" th:text="${cost.grossAmount().amount()} + ' ' + ${cost.grossAmount().currency()}">125.00 EUR</td>
                        <td>
                            <th:block th:if="${cost.documentStorageKey() != null}">
                                <a th:href="@{/costs/{id}/document(id=${cost.id()}, action='view')}"
                                   class="btn btn-sm btn-outline-primary" target="_blank">View</a>
                                <a th:href="@{/costs/{id}/document(id=${cost.id()}, action='download')}"
                                   class="btn btn-sm btn-outline-secondary">Download</a>
                            </th:block>
                        </td>
                        <td class="text-nowrap">
                            <button type="button" class="btn btn-sm btn-outline-primary edit-cost-btn"
                                    th:data-cost-id="${cost.id()}"
                                    th:data-cost-type="${cost.type()}"
                                    th:data-description="${cost.description()}"
                                    th:data-incurred-on="${cost.incurredOn()}"
                                    th:data-net-amount="${cost.netAmount().amount()}"
                                    th:data-vat-amount="${cost.vat().amount().amount()}"
                                    th:data-vat-rate="${#numbers.formatDecimal(cost.vat().rate(), 1, 2)}"
                                    th:data-gross-amount="${cost.grossAmount().amount()}"
                                    th:data-document-reference="${cost.documentReference()}"
                                    th:data-has-document="${cost.documentStorageKey() != null}">Edit</button>
                            <form th:action="@{/labels/{labelId}/releases/{releaseId}/costs/{costId}(labelId=${labelId}, releaseId=${releaseId}, costId=${cost.id()})}"
                                  method="post"
                                  class="d-inline"
                                  onsubmit="return confirm('Delete this cost?');">
                                <input type="hidden" name="_method" value="delete">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p th:if="${costs.isEmpty()}" class="text-muted p-3 mb-0">No costs recorded yet.</p>
        </div>
    </div>

    <!-- Add Cost Modal -->
    <div class="modal fade" id="addCostModal" tabindex="-1" aria-labelledby="addCostModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/labels/{labelId}/releases/{releaseId}/costs(labelId=${labelId}, releaseId=${releaseId})}" method="post" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addCostModalLabel">Add Cost</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="costType" class="form-label">Type</label>
                            <select class="form-select" id="costType" name="costType" required>
                                <option value="">Select type...</option>
                                <option th:each="type : ${allCostTypes}" th:value="${type}" th:text="${type}">TYPE</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="description" name="description" placeholder="e.g., Mastering at Studio X">
                        </div>
                        <div class="mb-3">
                            <label for="incurredOn" class="form-label">Date</label>
                            <input type="date" class="form-control" id="incurredOn" name="incurredOn" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="netAmount" class="form-label">Net Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="netAmount" name="netAmount" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vatRate" class="form-label">VAT Rate</label>
                                <select class="form-select" id="vatRate" name="vatRate" required>
                                    <option value="0.00">0%</option>
                                    <option value="0.09">9%</option>
                                    <option value="0.21" selected>21%</option>
                                    <option value="0.25">25%</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vatAmount" class="form-label">VAT Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="vatAmount" name="vatAmount" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="grossAmount" class="form-label">Gross Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="grossAmount" name="grossAmount" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="documentReference" class="form-label">Document Reference (optional)</label>
                            <input type="text" class="form-control" id="documentReference" name="documentReference" placeholder="e.g., INV-2024-001">
                        </div>
                        <div class="mb-3">
                            <label for="document" class="form-label">Upload Document (optional)</label>
                            <input type="file" class="form-control" id="document" name="document"
                                   accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx">
                            <div class="form-text">Supported: PDF, images (PNG, JPG), Word, Excel</div>
                        </div>
                        <div id="costValidationError" class="alert alert-danger d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="addCostSubmit">Add Cost</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Cost Modal -->
    <div class="modal fade" id="editCostModal" tabindex="-1" aria-labelledby="editCostModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editCostForm" method="post" enctype="multipart/form-data">
                    <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input type="hidden" name="_method" value="put">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editCostModalLabel">Edit Cost</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editCostType" class="form-label">Type</label>
                            <select class="form-select" id="editCostType" name="costType" required>
                                <option value="">Select type...</option>
                                <option th:each="type : ${allCostTypes}" th:value="${type}" th:text="${type}">TYPE</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <input type="text" class="form-control" id="editDescription" name="description" placeholder="e.g., Mastering at Studio X">
                        </div>
                        <div class="mb-3">
                            <label for="editIncurredOn" class="form-label">Date</label>
                            <input type="date" class="form-control" id="editIncurredOn" name="incurredOn" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editNetAmount" class="form-label">Net Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="editNetAmount" name="netAmount" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVatRate" class="form-label">VAT Rate</label>
                                <select class="form-select" id="editVatRate" name="vatRate" required>
                                    <option value="0.00">0%</option>
                                    <option value="0.09">9%</option>
                                    <option value="0.21">21%</option>
                                    <option value="0.25">25%</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editVatAmount" class="form-label">VAT Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="editVatAmount" name="vatAmount" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editGrossAmount" class="form-label">Gross Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="editGrossAmount" name="grossAmount" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editDocumentReference" class="form-label">Document Reference (optional)</label>
                            <input type="text" class="form-control" id="editDocumentReference" name="documentReference" placeholder="e.g., INV-2024-001">
                        </div>
                        <div class="mb-3">
                            <label for="editDocument" class="form-label">Replace Document (optional)</label>
                            <input type="file" class="form-control" id="editDocument" name="document"
                                   accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx">
                            <div class="form-text">Supported: PDF, images (PNG, JPG), Word, Excel</div>
                            <div id="editCurrentDocument" class="form-text text-success d-none">Current document attached</div>
                        </div>
                        <div id="editCostValidationError" class="alert alert-danger d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Release Modal -->
    <div class="modal fade" id="editReleaseModal" tabindex="-1" aria-labelledby="editReleaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/labels/{labelId}/releases/{releaseId}(labelId=${labelId}, releaseId=${releaseId})}" method="post" id="editReleaseForm">
                    <input type="hidden" name="_method" value="put">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editReleaseModalLabel">Edit Release</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Artists</label>
                            <select class="form-select mb-2" id="editReleaseArtistSelect">
                                <option value="">Select an artist...</option>
                                <option th:each="artist : ${allArtists}" th:value="${artist.id}" th:text="${artist.artistName}">Artist Name</option>
                            </select>
                            <div id="editReleaseArtistTags" class="d-flex flex-wrap gap-1"></div>
                            <div id="editReleaseArtistInputs"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editReleaseName" class="form-label">Release Name</label>
                            <input type="text" class="form-control" id="editReleaseName" name="releaseName" th:value="${name}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editReleaseDate" class="form-label">Release Date</label>
                            <input type="date" class="form-control" id="editReleaseDate" name="releaseDate" th:value="${releaseDate}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Formats</label>
                            <div>
                                <div th:each="format : ${allFormats}" class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="formats"
                                           th:id="'editFormat' + ${format}" th:value="${format}"
                                           th:checked="${formats.contains(format)}">
                                    <label class="form-check-label" th:for="'editFormat' + ${format}" th:text="${format}">Format</label>
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6>Tracks</h6>
                        <div id="editTrackContainer"></div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="editAddTrackBtn">+ Add Track</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module" th:inline="javascript">
    import { getArtistById, buildArtistOptions } from '/js/artist-utils.js';
    import { createTag } from '/js/tag-factory.js';
    import { formatDuration } from '/js/duration.js';
    import { validateCostForm } from '/js/cost-validation.js';

    document.addEventListener('DOMContentLoaded', function() {
        const editTrackContainer = document.getElementById('editTrackContainer');
        const editAddTrackBtn = document.getElementById('editAddTrackBtn');
        const editReleaseArtistSelect = document.getElementById('editReleaseArtistSelect');
        const editReleaseArtistTags = document.getElementById('editReleaseArtistTags');
        const editReleaseArtistInputs = document.getElementById('editReleaseArtistInputs');
        const editReleaseModal = document.getElementById('editReleaseModal');

        const allArtists = /*[[${allArtists}]]*/ [];
        const currentReleaseArtists = /*[[${artists}]]*/ [];
        const currentTracks = /*[[${tracks}]]*/ [];

        let editTrackIndex = 0;
        let selectedEditReleaseArtists = [];

        function addEditReleaseArtist(artistId) {
            if (!artistId || selectedEditReleaseArtists.includes(String(artistId))) return;
            const artist = getArtistById(allArtists, artistId);
            if (!artist) return;

            selectedEditReleaseArtists.push(String(artistId));

            const tag = createTag(artistId, artist.artistName, () => {
                selectedEditReleaseArtists = selectedEditReleaseArtists.filter(id => id !== String(artistId));
                tag.remove();
                const input = editReleaseArtistInputs.querySelector(`input[value="${artistId}"]`);
                if (input) input.remove();
            });
            editReleaseArtistTags.appendChild(tag);

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'artistIds';
            input.value = artistId;
            editReleaseArtistInputs.appendChild(input);

            editReleaseArtistSelect.value = '';
        }

        editReleaseArtistSelect.addEventListener('change', () => {
            addEditReleaseArtist(editReleaseArtistSelect.value);
        });

        function addEditTrackArtist(trackRow, artistId) {
            const trackIdx = trackRow.dataset.trackIndex;
            const tagsContainer = trackRow.querySelector('.track-artist-tags');
            const inputsContainer = trackRow.querySelector('.track-artist-inputs');
            const select = trackRow.querySelector('.track-artist-select');

            if (!artistId) return;
            if (inputsContainer.querySelector(`input[value="${artistId}"]`)) return;

            const artist = getArtistById(allArtists, artistId);
            if (!artist) return;

            addEditReleaseArtist(artistId);

            const tag = createTag(artistId, artist.artistName, () => {
                tag.remove();
                inputsContainer.querySelector(`input[value="${artistId}"]`).remove();
            });
            tagsContainer.appendChild(tag);

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `tracks[${trackIdx}].artistIds`;
            input.value = artistId;
            inputsContainer.appendChild(input);

            select.value = '';
        }

        function updateEditRemoveButtons() {
            const rows = editTrackContainer.querySelectorAll('.track-row');
            rows.forEach(row => {
                const removeBtn = row.querySelector('.remove-track');
                removeBtn.style.display = rows.length > 1 ? 'inline-block' : 'none';
            });
        }

        function reindexEditTracks() {
            const rows = editTrackContainer.querySelectorAll('.track-row');
            rows.forEach((row, index) => {
                row.dataset.trackIndex = index;
                row.querySelectorAll('input[name]').forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        input.setAttribute('name', name.replace(/tracks\[\d+\]/, 'tracks[' + index + ']'));
                    }
                });
            });
            editTrackIndex = rows.length - 1;
        }

        function createTrackRow(index, trackData) {
            const durationValue = trackData && trackData.duration
                ? formatDuration(trackData.duration.totalSeconds)
                : '';
            const nameValue = trackData ? trackData.name : '';

            const row = document.createElement('div');
            row.className = 'track-row mb-3 p-2 border rounded';
            row.dataset.trackIndex = index;
            row.innerHTML = `
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Artist</label>
                        <div class="input-group">
                            <select class="form-select track-artist-select">
                                <option value="">Select...</option>
                                ${buildArtistOptions(allArtists)}
                            </select>
                            <button class="btn btn-outline-secondary btn-sm add-track-artist-btn" type="button">+</button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="tracks[${index}].name" value="${nameValue}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Duration</label>
                        <input type="text" class="form-control" name="tracks[${index}].duration" placeholder="MM:SS" pattern="[0-9]+:[0-5][0-9]" value="${durationValue}" required>
                    </div>
                    <div class="col-md-1 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-track">X</button>
                    </div>
                </div>
                <div class="track-artist-tags d-flex flex-wrap gap-1 mt-2"></div>
                <div class="track-artist-inputs"></div>
            `;
            return row;
        }

        function initializeEditModal() {
            selectedEditReleaseArtists = [];
            editReleaseArtistTags.innerHTML = '';
            editReleaseArtistInputs.innerHTML = '';
            editTrackContainer.innerHTML = '';
            editTrackIndex = 0;

            currentReleaseArtists.forEach(artist => {
                addEditReleaseArtist(artist.id);
            });

            currentTracks.forEach((track, index) => {
                const row = createTrackRow(index, track);
                editTrackContainer.appendChild(row);

                track.artists.forEach(artist => {
                    addEditTrackArtist(row, artist.id);
                });

                editTrackIndex = index;
            });

            if (currentTracks.length === 0) {
                const row = createTrackRow(0, null);
                editTrackContainer.appendChild(row);
            }

            updateEditRemoveButtons();
        }

        editReleaseModal.addEventListener('show.bs.modal', initializeEditModal);

        editAddTrackBtn.addEventListener('click', function() {
            editTrackIndex++;
            const newRow = createTrackRow(editTrackIndex, null);
            editTrackContainer.appendChild(newRow);

            selectedEditReleaseArtists.forEach(artistId => {
                addEditTrackArtist(newRow, artistId);
            });

            updateEditRemoveButtons();
        });

        editTrackContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-track')) {
                e.target.closest('.track-row').remove();
                reindexEditTracks();
                updateEditRemoveButtons();
            }
            if (e.target.classList.contains('add-track-artist-btn')) {
                const trackRow = e.target.closest('.track-row');
                const select = trackRow.querySelector('.track-artist-select');
                addEditTrackArtist(trackRow, select.value);
            }
        });

        editTrackContainer.addEventListener('change', function(e) {
            if (e.target.classList.contains('track-artist-select')) {
                const trackRow = e.target.closest('.track-row');
                addEditTrackArtist(trackRow, e.target.value);
            }
        });

        // Cost form validation
        const addCostForm = document.querySelector('#addCostModal form');
        const costValidationError = document.getElementById('costValidationError');

        addCostForm.addEventListener('submit', function(e) {
            const netAmount = parseFloat(document.getElementById('netAmount').value) || 0;
            const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
            const vatAmount = parseFloat(document.getElementById('vatAmount').value) || 0;
            const grossAmount = parseFloat(document.getElementById('grossAmount').value) || 0;

            const errors = validateCostForm(netAmount, vatRate, vatAmount, grossAmount);

            if (errors.length > 0) {
                e.preventDefault();
                costValidationError.innerHTML = errors.join('<br>');
                costValidationError.classList.remove('d-none');
            } else {
                costValidationError.classList.add('d-none');
            }
        });

        // Clear validation error when modal is closed
        document.getElementById('addCostModal').addEventListener('hidden.bs.modal', function() {
            costValidationError.classList.add('d-none');
        });

        // Edit Cost Modal
        const editCostModal = document.getElementById('editCostModal');
        const editCostForm = document.getElementById('editCostForm');
        const editCostValidationError = document.getElementById('editCostValidationError');
        const labelId = /*[[${labelId}]]*/ 0;
        const releaseId = /*[[${releaseId}]]*/ 0;
        const editCurrentDocument = document.getElementById('editCurrentDocument');

        document.querySelectorAll('.edit-cost-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const costId = this.dataset.costId;
                const costType = this.dataset.costType;
                const description = this.dataset.description;
                const incurredOn = this.dataset.incurredOn;
                const netAmount = this.dataset.netAmount;
                const vatAmount = this.dataset.vatAmount;
                const vatRate = this.dataset.vatRate;
                const grossAmount = this.dataset.grossAmount;
                const documentReference = this.dataset.documentReference;
                const hasDocument = this.dataset.hasDocument === 'true';

                editCostForm.action = `/labels/${labelId}/releases/${releaseId}/costs/${costId}`;
                document.getElementById('editCostType').value = costType;
                document.getElementById('editDescription').value = description || '';
                document.getElementById('editIncurredOn').value = incurredOn;
                document.getElementById('editNetAmount').value = netAmount;
                document.getElementById('editVatAmount').value = vatAmount;
                document.getElementById('editVatRate').value = vatRate;
                document.getElementById('editGrossAmount').value = grossAmount;
                document.getElementById('editDocumentReference').value = documentReference || '';
                document.getElementById('editDocument').value = '';

                if (hasDocument) {
                    editCurrentDocument.classList.remove('d-none');
                } else {
                    editCurrentDocument.classList.add('d-none');
                }

                new bootstrap.Modal(editCostModal).show();
            });
        });

        editCostForm.addEventListener('submit', function(e) {
            const netAmount = parseFloat(document.getElementById('editNetAmount').value) || 0;
            const vatRate = parseFloat(document.getElementById('editVatRate').value) || 0;
            const vatAmount = parseFloat(document.getElementById('editVatAmount').value) || 0;
            const grossAmount = parseFloat(document.getElementById('editGrossAmount').value) || 0;

            const errors = validateCostForm(netAmount, vatRate, vatAmount, grossAmount);

            if (errors.length > 0) {
                e.preventDefault();
                editCostValidationError.innerHTML = errors.join('<br>');
                editCostValidationError.classList.remove('d-none');
            } else {
                editCostValidationError.classList.add('d-none');
            }
        });

        editCostModal.addEventListener('hidden.bs.modal', function() {
            editCostValidationError.classList.add('d-none');
        });
    });
    </script>
</main>
</html>
