<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: page(title=${name}, content=~{::main})}">
<main>
    <style>
        .extracted-field {
            background-color: #d4edda !important;
            transition: background-color 0.5s ease;
        }
    </style>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-2">
            <h1 th:text="${name}" class="mb-0">Release Name</h1>
            <button type="button" class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal" data-bs-target="#editReleaseModal">
                Edit
            </button>
        </div>
        <div>
            <a th:href="@{/labels/{labelId}(labelId=${labelId})}"
               class="btn btn-outline-secondary">Back to Label</a>
            <form th:action="@{/labels/{labelId}/releases/{releaseId}(labelId=${labelId}, releaseId=${releaseId})}"
                  method="post"
                  class="d-inline"
                  onsubmit="return confirm('Delete this release and all its tracks?');">
                <input type="hidden" name="_method" value="delete">
                <button type="submit" class="btn btn-outline-danger">Delete</button>
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-3">Artists</dt>
                <dd class="col-sm-9" th:text="${#strings.listJoin(artists.![artistName], ', ')}">Artist Names</dd>

                <dt class="col-sm-3">Release Date</dt>
                <dd class="col-sm-9" th:text="${releaseDate}">2024-01-01</dd>

                <dt class="col-sm-3">Formats</dt>
                <dd class="col-sm-9">
                    <span th:each="format : ${formats}" class="badge bg-primary me-1" th:text="${format}">Format</span>
                    <span th:if="${#sets.isEmpty(formats)}" class="text-muted">No formats specified</span>
                </dd>
            </dl>
        </div>
    </div>

    <h2 class="h4 mb-3">Tracks</h2>
    <div class="card">
        <div class="card-body p-0">
            <table class="table table-striped mb-0">
                <thead>
                    <tr>
                        <th scope="col" style="width: 50px">#</th>
                        <th scope="col">Artist</th>
                        <th scope="col">Title</th>
                        <th scope="col" style="width: 80px">Duration</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="track : ${tracks}">
                        <td th:text="${track.position()}">1</td>
                        <td>
                            <span th:text="${#strings.listJoin(track.artists().![artistName], ', ')}">Artist Name</span>
                            <span th:if="${!track.remixers().isEmpty()}" class="text-muted">
                                (remixed by
                                <span th:each="remixer, iterStat : ${track.remixers()}">
                                    <a th:href="@{/artists/{id}(id=${remixer.id()})}"
                                       th:text="${remixer.artistName()}">Remixer</a><span th:if="${!iterStat.last}">, </span>
                                </span>)
                            </span>
                        </td>
                        <td th:text="${track.name()}">Track Name</td>
                        <td th:text="${track.duration().formatted()}">3:30</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex align-items-center gap-2 mt-4 mb-3">
        <h2 class="h4 mb-0">Costs</h2>
        <button type="button" class="btn btn-outline-primary btn-sm"
                data-bs-toggle="modal" data-bs-target="#addCostModal">+</button>
    </div>
    <div class="card mb-4">
        <div class="card-body p-0">
            <table class="table table-striped mb-0" th:if="${!costs.isEmpty()}">
                <thead>
                    <tr>
                        <th scope="col">Date</th>
                        <th scope="col">Type</th>
                        <th scope="col">Description</th>
                        <th scope="col" class="text-end">Net</th>
                        <th scope="col" class="text-end">VAT</th>
                        <th scope="col" class="text-end">Gross</th>
                        <th scope="col">Document</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="cost : ${costs}">
                        <td th:text="${cost.incurredOn()}">2024-01-01</td>
                        <td th:text="${cost.type()}">MASTERING</td>
                        <td th:text="${cost.description()}">Description</td>
                        <td class="text-end" th:text="${cost.netAmount().amount()} + ' ' + ${cost.netAmount().currency()}">100.00 EUR</td>
                        <td class="text-end" th:text="${cost.vat().amount().amount()} + ' (' + ${#numbers.formatPercent(cost.vat().rate(), 1, 0)} + ')'">25.00 (25%)</td>
                        <td class="text-end" th:text="${cost.grossAmount().amount()} + ' ' + ${cost.grossAmount().currency()}">125.00 EUR</td>
                        <td>
                            <th:block th:if="${cost.documentStorageKey() != null}">
                                <a th:href="@{/costs/{id}/document(id=${cost.id()}, action='view')}"
                                   class="btn btn-sm btn-outline-primary" target="_blank">View</a>
                                <a th:href="@{/costs/{id}/document(id=${cost.id()}, action='download')}"
                                   class="btn btn-sm btn-outline-secondary">Download</a>
                            </th:block>
                        </td>
                        <td class="text-nowrap">
                            <button type="button" class="btn btn-sm btn-outline-primary edit-cost-btn"
                                    th:data-cost-id="${cost.id()}"
                                    th:data-cost-type="${cost.type()}"
                                    th:data-description="${cost.description()}"
                                    th:data-incurred-on="${cost.incurredOn()}"
                                    th:data-net-amount="${cost.netAmount().amount()}"
                                    th:data-vat-amount="${cost.vat().amount().amount()}"
                                    th:data-vat-rate="${#numbers.formatDecimal(cost.vat().rate(), 1, 2)}"
                                    th:data-gross-amount="${cost.grossAmount().amount()}"
                                    th:data-document-reference="${cost.documentReference()}">Edit</button>
                            <form th:action="@{/labels/{labelId}/releases/{releaseId}/costs/{costId}(labelId=${labelId}, releaseId=${releaseId}, costId=${cost.id()})}"
                                  method="post"
                                  class="d-inline"
                                  onsubmit="return confirm('Delete this cost?');">
                                <input type="hidden" name="_method" value="delete">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p th:if="${costs.isEmpty()}" class="text-muted p-3 mb-0">No costs recorded yet.</p>
        </div>
    </div>

    <div class="d-flex align-items-center gap-2 mt-4 mb-3">
        <h2 class="h4 mb-0">Production Runs</h2>
        <button type="button" class="btn btn-outline-primary btn-sm"
                data-bs-toggle="modal" data-bs-target="#addProductionRunModal">+</button>
    </div>
    <div th:if="${allocationError}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${allocationError}">Error message</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div class="card mb-4">
        <div class="card-body p-0">
            <table class="table table-striped mb-0" th:if="${!productionRuns.isEmpty()}">
                <thead>
                    <tr>
                        <th scope="col">Format</th>
                        <th scope="col">Description</th>
                        <th scope="col">Manufacturer</th>
                        <th scope="col">Date</th>
                        <th scope="col" class="text-end">Manufactured</th>
                        <th scope="col" class="text-end">Allocated</th>
                        <th scope="col" class="text-end">Unallocated</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    <th:block th:each="runWithAlloc, iterStat : ${productionRuns}">
                        <tr>
                            <td th:text="${runWithAlloc.productionRun().format()}">VINYL</td>
                            <td th:text="${runWithAlloc.productionRun().description()}">Original pressing</td>
                            <td th:text="${runWithAlloc.productionRun().manufacturer()}">Record Industry</td>
                            <td th:text="${runWithAlloc.productionRun().manufacturingDate()}">2025-01-01</td>
                            <td class="text-end" th:text="${runWithAlloc.productionRun().quantity()}">500</td>
                            <td class="text-end">
                                <span th:text="${runWithAlloc.allocated()}">200</span>
                                <button th:if="${!runWithAlloc.allocations().isEmpty()}"
                                        type="button"
                                        class="btn btn-link btn-sm p-0 ms-1"
                                        data-bs-toggle="collapse"
                                        th:data-bs-target="'#allocations-' + ${iterStat.index}"
                                        aria-expanded="false">
                                    <small>details</small>
                                </button>
                            </td>
                            <td class="text-end" th:text="${runWithAlloc.unallocated()}">300</td>
                            <td class="text-nowrap">
                                <button type="button" class="btn btn-sm btn-outline-primary allocate-btn"
                                        th:if="${runWithAlloc.unallocated() > 0 && !distributors.isEmpty()}"
                                        th:data-run-id="${runWithAlloc.productionRun().id()}"
                                        th:data-unallocated="${runWithAlloc.unallocated()}"
                                        data-bs-toggle="modal" data-bs-target="#allocateModal">Allocate</button>
                                <form th:action="@{/labels/{labelId}/releases/{releaseId}/production-runs/{runId}(labelId=${labelId}, releaseId=${releaseId}, runId=${runWithAlloc.productionRun().id()})}"
                                      method="post"
                                      class="d-inline"
                                      onsubmit="return confirm('Delete this production run?');">
                                    <input type="hidden" name="_method" value="delete">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                        <tr th:if="${!runWithAlloc.allocations().isEmpty()}"
                            class="collapse"
                            th:id="'allocations-' + ${iterStat.index}">
                            <td colspan="8" class="bg-light p-0">
                                <table class="table table-sm mb-0">
                                    <thead>
                                        <tr class="table-secondary">
                                            <th>Channel</th>
                                            <th class="text-end">Quantity</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="alloc : ${runWithAlloc.allocations()}">
                                            <td th:text="${alloc.channelName()}">Direct Sales</td>
                                            <td class="text-end" th:text="${alloc.quantity()}">100</td>
                                            <td th:text="${#temporals.format(alloc.allocatedAt(), 'yyyy-MM-dd HH:mm')}">2025-01-15 10:00</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </th:block>
                </tbody>
            </table>
            <p th:if="${productionRuns.isEmpty()}" class="text-muted p-3 mb-0">
                No production runs recorded yet.
            </p>
        </div>
    </div>

    <!-- Add Production Run Modal -->
    <div class="modal fade" id="addProductionRunModal" tabindex="-1"
         aria-labelledby="addProductionRunModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/labels/{labelId}/releases/{releaseId}/production-runs(labelId=${labelId}, releaseId=${releaseId})}"
                      method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addProductionRunModalLabel">
                            Add Production Run
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="productionRunFormat" class="form-label">Format</label>
                            <select class="form-select" id="productionRunFormat" name="format"
                                    required>
                                <option value="">Select format...</option>
                                <option th:each="format : ${physicalFormats}"
                                        th:value="${format}" th:text="${format}">VINYL</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="productionRunDescription" class="form-label">
                                Description (optional)
                            </label>
                            <input type="text" class="form-control" id="productionRunDescription"
                                   name="description"
                                   placeholder="e.g., Original pressing, 2nd pressing">
                        </div>
                        <div class="mb-3">
                            <label for="productionRunManufacturer" class="form-label">
                                Manufacturer
                            </label>
                            <input type="text" class="form-control" id="productionRunManufacturer"
                                   name="manufacturer" required
                                   placeholder="e.g., Record Industry">
                        </div>
                        <div class="mb-3">
                            <label for="productionRunManufacturingDate" class="form-label">
                                Manufacturing Date
                            </label>
                            <input type="date" class="form-control"
                                   id="productionRunManufacturingDate"
                                   name="manufacturingDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="productionRunQuantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="productionRunQuantity"
                                   name="quantity" required min="1"
                                   placeholder="e.g., 500">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary"
                                data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Production Run</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Allocate Inventory Modal -->
    <div class="modal fade" id="allocateModal" tabindex="-1"
         aria-labelledby="allocateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="allocateForm" method="post">
                    <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <div class="modal-header">
                        <h5 class="modal-title" id="allocateModalLabel">
                            Allocate Inventory
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="allocationDistributorId" class="form-label">
                                Distributor
                            </label>
                            <select class="form-select" id="allocationDistributorId"
                                    name="distributorId" required>
                                <option value="">Select distributor...</option>
                                <option th:each="distributor : ${distributors}"
                                        th:value="${distributor.id()}"
                                        th:text="${distributor.name()} + ' (' + ${distributor.channelType()} + ')'">
                                    Distributor Name
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="allocationQuantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="allocationQuantity"
                                   name="quantity" required min="1">
                            <div class="form-text">
                                Unallocated: <span id="allocationUnallocatedDisplay">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary"
                                data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Allocate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Cost Modal -->
    <div class="modal fade" id="addCostModal" tabindex="-1" aria-labelledby="addCostModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/labels/{labelId}/releases/{releaseId}/costs(labelId=${labelId}, releaseId=${releaseId})}" method="post" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addCostModalLabel">Add Cost</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="costType" class="form-label">Type</label>
                            <select class="form-select" id="costType" name="costType" required>
                                <option value="">Select type...</option>
                                <option th:each="type : ${allCostTypes}" th:value="${type}" th:text="${type}">TYPE</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="description" name="description" placeholder="e.g., Mastering at Studio X">
                        </div>
                        <div class="mb-3">
                            <label for="incurredOn" class="form-label">Date</label>
                            <input type="date" class="form-control" id="incurredOn" name="incurredOn" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="netAmount" class="form-label">Net Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="netAmount" name="netAmount" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vatRate" class="form-label">VAT Rate</label>
                                <select class="form-select" id="vatRate" name="vatRate" required>
                                    <option value="0.00">0%</option>
                                    <option value="0.09">9%</option>
                                    <option value="0.21" selected>21%</option>
                                    <option value="0.25">25%</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vatAmount" class="form-label">VAT Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="vatAmount" name="vatAmount" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="grossAmount" class="form-label">Gross Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="grossAmount" name="grossAmount" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="documentReference" class="form-label">Document Reference (optional)</label>
                            <input type="text" class="form-control" id="documentReference" name="documentReference" placeholder="e.g., INV-2024-001">
                        </div>
                        <div class="mb-3">
                            <label for="document" class="form-label">Upload Document (optional)</label>
                            <input type="file" class="form-control" id="document" name="document"
                                   accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx"
                                   data-testid="cost-document-input">
                            <div class="form-text">Supported: PDF, images (PNG, JPG), Word, Excel</div>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2 d-none"
                                    id="extractInvoiceBtn"
                                    data-testid="extract-invoice-button">
                                Extract from Document
                            </button>
                        </div>
                        <div id="costValidationError" class="alert alert-danger d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="addCostSubmit">Add Cost</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Cost Modal -->
    <div class="modal fade" id="editCostModal" tabindex="-1" aria-labelledby="editCostModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editCostForm" method="post">
                    <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input type="hidden" name="_method" value="put">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editCostModalLabel">Edit Cost</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editCostType" class="form-label">Type</label>
                            <select class="form-select" id="editCostType" name="costType" required>
                                <option value="">Select type...</option>
                                <option th:each="type : ${allCostTypes}" th:value="${type}" th:text="${type}">TYPE</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <input type="text" class="form-control" id="editDescription" name="description" placeholder="e.g., Mastering at Studio X">
                        </div>
                        <div class="mb-3">
                            <label for="editIncurredOn" class="form-label">Date</label>
                            <input type="date" class="form-control" id="editIncurredOn" name="incurredOn" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editNetAmount" class="form-label">Net Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="editNetAmount" name="netAmount" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVatRate" class="form-label">VAT Rate</label>
                                <select class="form-select" id="editVatRate" name="vatRate" required>
                                    <option value="0.00">0%</option>
                                    <option value="0.09">9%</option>
                                    <option value="0.21">21%</option>
                                    <option value="0.25">25%</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editVatAmount" class="form-label">VAT Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="editVatAmount" name="vatAmount" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editGrossAmount" class="form-label">Gross Amount (EUR)</label>
                                <input type="number" step="0.01" class="form-control" id="editGrossAmount" name="grossAmount" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editDocumentReference" class="form-label">Document Reference (optional)</label>
                            <input type="text" class="form-control" id="editDocumentReference" name="documentReference" placeholder="e.g., INV-2024-001">
                        </div>
                        <div id="editCostValidationError" class="alert alert-danger d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Release Modal -->
    <div class="modal fade" id="editReleaseModal" tabindex="-1" aria-labelledby="editReleaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/labels/{labelId}/releases/{releaseId}(labelId=${labelId}, releaseId=${releaseId})}" method="post" id="editReleaseForm">
                    <input type="hidden" name="_method" value="put">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editReleaseModalLabel">Edit Release</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Artists</label>
                            <select class="form-select mb-2" id="editReleaseArtistSelect">
                                <option value="">Select an artist...</option>
                                <option th:each="artist : ${allArtists}" th:value="${artist.id}" th:text="${artist.artistName}">Artist Name</option>
                            </select>
                            <div id="editReleaseArtistTags" class="d-flex flex-wrap gap-1"></div>
                            <div id="editReleaseArtistInputs"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editReleaseName" class="form-label">Release Name</label>
                            <input type="text" class="form-control" id="editReleaseName" name="releaseName" th:value="${name}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editReleaseDate" class="form-label">Release Date</label>
                            <input type="date" class="form-control" id="editReleaseDate" name="releaseDate" th:value="${releaseDate}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Formats</label>
                            <div>
                                <div th:each="format : ${allFormats}" class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="formats"
                                           th:id="'editFormat' + ${format}" th:value="${format}"
                                           th:checked="${formats.contains(format)}">
                                    <label class="form-check-label" th:for="'editFormat' + ${format}" th:text="${format}">Format</label>
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6>Tracks</h6>
                        <div id="editTrackContainer"></div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="editAddTrackBtn">+ Add Track</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module" th:inline="javascript">
    import { createArtistSelection } from '/js/artist-selection.js';
    import { createTrackList } from '/js/track-list.js';
    import {
        setupCostFormValidation,
        setupEditCostModal,
        setupEditCostButtons,
    } from '/js/cost-form.js';
    import { setupInvoiceExtraction } from '/js/invoice-extraction.js';

    document.addEventListener('DOMContentLoaded', function() {
        const allArtists = /*[[${allArtists}]]*/ [];
        const currentReleaseArtists = /*[[${artists}]]*/ [];
        const currentTracks = /*[[${tracks}]]*/ [];
        const labelId = /*[[${labelId}]]*/ 0;
        const releaseId = /*[[${releaseId}]]*/ 0;

        // Edit Release Modal - Artist selection
        const editReleaseArtistSelection = createArtistSelection({
            artists: allArtists,
            selectElement: document.getElementById('editReleaseArtistSelect'),
            tagsContainer: document.getElementById('editReleaseArtistTags'),
            inputsContainer: document.getElementById('editReleaseArtistInputs'),
            inputName: 'artistIds',
        });

        // Edit Release Modal - Track list
        const editTrackList = createTrackList({
            container: document.getElementById('editTrackContainer'),
            addButton: document.getElementById('editAddTrackBtn'),
            artists: allArtists,
            onTrackArtistAdd: (artistId) => editReleaseArtistSelection.add(artistId),
            getSelectedReleaseArtists: () => editReleaseArtistSelection.getSelectedIds(),
        });

        // Initialize edit modal when shown
        const editReleaseModal = document.getElementById('editReleaseModal');
        editReleaseModal.addEventListener('show.bs.modal', function() {
            editReleaseArtistSelection.clear();
            currentReleaseArtists.forEach(artist => editReleaseArtistSelection.add(artist.id));
            editTrackList.initialize(currentTracks);
        });

        // Add Cost Form Validation
        setupCostFormValidation({
            form: document.querySelector('#addCostModal form'),
            errorContainer: document.getElementById('costValidationError'),
            fields: {
                netAmount: '#netAmount',
                vatRate: '#vatRate',
                vatAmount: '#vatAmount',
                grossAmount: '#grossAmount',
            },
        });

        // Invoice extraction for add cost modal
        const addCostForm = document.querySelector('#addCostModal form');
        const csrfToken = addCostForm.querySelector('input[name="_csrf"]')?.value || '';
        setupInvoiceExtraction({
            fileInput: document.getElementById('document'),
            extractButton: document.getElementById('extractInvoiceBtn'),
            fieldIds: {
                netAmount: 'netAmount',
                vatAmount: 'vatAmount',
                grossAmount: 'grossAmount',
                vatRate: 'vatRate',
                incurredOn: 'incurredOn',
                documentReference: 'documentReference',
            },
            csrfToken: csrfToken,
        });

        // Clear add cost validation error when modal is closed
        document.getElementById('addCostModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('costValidationError').classList.add('d-none');
        });

        // Edit Cost Modal
        const editCostModalHandler = setupEditCostModal({
            modal: document.getElementById('editCostModal'),
            form: document.getElementById('editCostForm'),
            errorContainer: document.getElementById('editCostValidationError'),
            actionUrlTemplate: `/labels/${labelId}/releases/${releaseId}/costs/{costId}`,
            fieldIds: {
                costType: 'editCostType',
                description: 'editDescription',
                incurredOn: 'editIncurredOn',
                netAmount: 'editNetAmount',
                vatAmount: 'editVatAmount',
                vatRate: 'editVatRate',
                grossAmount: 'editGrossAmount',
                documentReference: 'editDocumentReference',
            },
        });

        setupEditCostButtons('.edit-cost-btn', editCostModalHandler);

        // Allocate Inventory Modal
        const allocateForm = document.getElementById('allocateForm');
        const allocateModal = document.getElementById('allocateModal');
        const allocationQuantity = document.getElementById('allocationQuantity');
        const allocationUnallocatedDisplay =
                document.getElementById('allocationUnallocatedDisplay');

        document.querySelectorAll('.allocate-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const runId = this.dataset.runId;
                const unallocated = parseInt(this.dataset.unallocated, 10);

                allocateForm.action =
                    `/labels/${labelId}/releases/${releaseId}/production-runs/${runId}/allocations`;
                allocationQuantity.max = unallocated;
                allocationQuantity.value = '';
                allocationUnallocatedDisplay.textContent = unallocated;
            });
        });
    });
    </script>
</main>
</html>
