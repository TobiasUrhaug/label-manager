<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: page(title=${name}, content=~{::main})}">
<main>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-2">
            <h1 th:text="${name}" class="mb-0">Label Name</h1>
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editLabelModal">
                Edit
            </button>
        </div>
        <a th:href="@{/dashboard}" class="btn btn-outline-secondary">Back to Dashboard</a>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-2" th:if="${owner}">Owner</dt>
                <dd class="col-sm-10" th:if="${owner}" th:text="${owner.name}">Owner Name</dd>

                <dt class="col-sm-2" th:if="${email}">Email</dt>
                <dd class="col-sm-10" th:if="${email}">
                    <a th:href="@{'mailto:' + ${email}}" th:text="${email}">email@example.com</a>
                </dd>

                <dt class="col-sm-2" th:if="${website}">Website</dt>
                <dd class="col-sm-10" th:if="${website}">
                    <a th:href="${website}" th:text="${website}" target="_blank" rel="noopener">https://example.com</a>
                </dd>

                <dt class="col-sm-2" th:if="${address}">Address</dt>
                <dd class="col-sm-10" th:if="${address}">
                    <span th:text="${address.street}">Street</span><br th:if="${address.street2}">
                    <span th:if="${address.street2}" th:text="${address.street2}">Street 2</span><br>
                    <span th:text="${address.postalCode}">Postal</span>
                    <span th:text="${address.city}">City</span><br>
                    <span th:text="${address.country}">Country</span>
                </dd>
            </dl>
        </div>
    </div>

    <button type="button" class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#createReleaseModal">
        Add Release
    </button>

    <h2 class="mb-3">Releases</h2>

    <div th:if="${#lists.isEmpty(releases)}" class="alert alert-info">
        No releases yet. Add one above!
    </div>

    <div class="list-group" th:unless="${#lists.isEmpty(releases)}">
        <a th:each="release : ${releases}"
           th:href="@{/labels/{labelId}/releases/{releaseId}(labelId=${id}, releaseId=${release.id})}"
           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <span th:text="${release.name}">Release Name</span>
            <span class="badge bg-secondary" th:text="${release.releaseDate}">Date</span>
        </a>
    </div>

    <!-- Create Release Modal -->
    <div class="modal fade" id="createReleaseModal" tabindex="-1" aria-labelledby="createReleaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/labels/{labelId}/releases(labelId=${id})}" method="post" id="createReleaseForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createReleaseModalLabel">Create Release</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Artists</label>
                            <select class="form-select mb-2" id="releaseArtistSelect">
                                <option value="">Select an artist...</option>
                                <option th:each="artist : ${artists}" th:value="${artist.id}" th:text="${artist.artistName}">Artist Name</option>
                            </select>
                            <div id="releaseArtistTags" class="d-flex flex-wrap gap-1"></div>
                            <div id="releaseArtistInputs"></div>
                        </div>
                        <div class="mb-3">
                            <label for="releaseName" class="form-label">Release Name</label>
                            <input type="text" class="form-control" id="releaseName" name="releaseName" required>
                        </div>
                        <div class="mb-3">
                            <label for="releaseDate" class="form-label">Release Date</label>
                            <input type="date" class="form-control" id="releaseDate" name="releaseDate" required>
                        </div>

                        <hr>
                        <h6>Tracks</h6>
                        <div id="trackContainer">
                            <div class="track-row mb-3 p-2 border rounded" data-track-index="0">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label">Artist</label>
                                        <div class="input-group">
                                            <select class="form-select track-artist-select">
                                                <option value="">Select...</option>
                                                <option th:each="artist : ${artists}" th:value="${artist.id}" th:text="${artist.artistName}">Artist Name</option>
                                            </select>
                                            <button class="btn btn-outline-secondary btn-sm add-track-artist-btn" type="button">+</button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Name</label>
                                        <input type="text" class="form-control" name="tracks[0].name" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Duration</label>
                                        <input type="text" class="form-control" name="tracks[0].duration" placeholder="MM:SS" pattern="[0-9]+:[0-5][0-9]" required>
                                    </div>
                                    <div class="col-md-1 text-end">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-track" style="display: none;">X</button>
                                    </div>
                                </div>
                                <div class="track-artist-tags d-flex flex-wrap gap-1 mt-2"></div>
                                <div class="track-artist-inputs"></div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="addTrackBtn">+ Add Track</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const trackContainer = document.getElementById('trackContainer');
        const addTrackBtn = document.getElementById('addTrackBtn');
        const releaseArtistSelect = document.getElementById('releaseArtistSelect');
        const releaseArtistTags = document.getElementById('releaseArtistTags');
        const releaseArtistInputs = document.getElementById('releaseArtistInputs');
        const createReleaseModal = document.getElementById('createReleaseModal');
        const artists = /*[[${artists}]]*/ [];
        let trackIndex = 0;
        let selectedReleaseArtists = [];

        // Reset modal state when closed
        createReleaseModal.addEventListener('hidden.bs.modal', function() {
            selectedReleaseArtists = [];
            releaseArtistTags.innerHTML = '';
            releaseArtistInputs.innerHTML = '';
            releaseArtistSelect.value = '';
            document.getElementById('createReleaseForm').reset();
            // Reset tracks to single empty track
            trackContainer.innerHTML = `
                <div class="track-row mb-3 p-2 border rounded" data-track-index="0">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Artist</label>
                            <div class="input-group">
                                <select class="form-select track-artist-select">
                                    <option value="">Select...</option>
                                    ${buildArtistOptions()}
                                </select>
                                <button class="btn btn-outline-secondary btn-sm add-track-artist-btn" type="button">+</button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="tracks[0].name" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Duration</label>
                            <input type="text" class="form-control" name="tracks[0].duration" placeholder="MM:SS" pattern="[0-9]+:[0-5][0-9]" required>
                        </div>
                        <div class="col-md-1 text-end">
                            <button type="button" class="btn btn-outline-danger btn-sm remove-track" style="display: none;">X</button>
                        </div>
                    </div>
                    <div class="track-artist-tags d-flex flex-wrap gap-1 mt-2"></div>
                    <div class="track-artist-inputs"></div>
                </div>
            `;
            trackIndex = 0;
        });

        function getArtistById(id) {
            return artists.find(a => String(a.id) === String(id));
        }

        function createTag(artistId, artistName, onRemove) {
            const tag = document.createElement('span');
            tag.className = 'badge bg-secondary d-flex align-items-center gap-1';
            tag.innerHTML = `${artistName} <button type="button" class="btn-close btn-close-white" style="font-size: 0.6rem;" aria-label="Remove"></button>`;
            tag.querySelector('button').addEventListener('click', onRemove);
            tag.dataset.artistId = artistId;
            return tag;
        }

        function addReleaseArtist(artistId) {
            if (!artistId || selectedReleaseArtists.includes(artistId)) return;
            const artist = getArtistById(artistId);
            if (!artist) return;

            selectedReleaseArtists.push(artistId);

            const tag = createTag(artistId, artist.artistName, () => {
                selectedReleaseArtists = selectedReleaseArtists.filter(id => id !== artistId);
                tag.remove();
                releaseArtistInputs.querySelector(`input[value="${artistId}"]`).remove();
            });
            releaseArtistTags.appendChild(tag);

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'artistIds';
            input.value = artistId;
            releaseArtistInputs.appendChild(input);

            releaseArtistSelect.value = '';
        }

        // Auto-add artist when selecting from dropdown
        releaseArtistSelect.addEventListener('change', () => {
            addReleaseArtist(releaseArtistSelect.value);
        });

        function addTrackArtist(trackRow, artistId) {
            const trackIdx = trackRow.dataset.trackIndex;
            const tagsContainer = trackRow.querySelector('.track-artist-tags');
            const inputsContainer = trackRow.querySelector('.track-artist-inputs');
            const select = trackRow.querySelector('.track-artist-select');

            if (!artistId) return;
            if (inputsContainer.querySelector(`input[value="${artistId}"]`)) return;

            const artist = getArtistById(artistId);
            if (!artist) return;

            // Also add to release artists if not already there
            addReleaseArtist(artistId);

            const tag = createTag(artistId, artist.artistName, () => {
                tag.remove();
                inputsContainer.querySelector(`input[value="${artistId}"]`).remove();
            });
            tagsContainer.appendChild(tag);

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `tracks[${trackIdx}].artistIds`;
            input.value = artistId;
            inputsContainer.appendChild(input);

            select.value = '';
        }

        function updateRemoveButtons() {
            const rows = trackContainer.querySelectorAll('.track-row');
            rows.forEach(row => {
                const removeBtn = row.querySelector('.remove-track');
                removeBtn.style.display = rows.length > 1 ? 'inline-block' : 'none';
            });
        }

        function reindexTracks() {
            const rows = trackContainer.querySelectorAll('.track-row');
            rows.forEach((row, index) => {
                row.dataset.trackIndex = index;
                row.querySelectorAll('input[name]').forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        input.setAttribute('name', name.replace(/tracks\[\d+\]/, 'tracks[' + index + ']'));
                    }
                });
            });
            trackIndex = rows.length - 1;
        }

        function buildArtistOptions() {
            return artists.map(artist =>
                `<option value="${artist.id}">${artist.artistName}</option>`
            ).join('');
        }

        addTrackBtn.addEventListener('click', function() {
            trackIndex++;
            const newRow = document.createElement('div');
            newRow.className = 'track-row mb-3 p-2 border rounded';
            newRow.dataset.trackIndex = trackIndex;
            newRow.innerHTML = `
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Artist</label>
                        <div class="input-group">
                            <select class="form-select track-artist-select">
                                <option value="">Select...</option>
                                ${buildArtistOptions()}
                            </select>
                            <button class="btn btn-outline-secondary btn-sm add-track-artist-btn" type="button">+</button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="tracks[${trackIndex}].name" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Duration</label>
                        <input type="text" class="form-control" name="tracks[${trackIndex}].duration" placeholder="MM:SS" pattern="[0-9]+:[0-5][0-9]" required>
                    </div>
                    <div class="col-md-1 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-track">X</button>
                    </div>
                </div>
                <div class="track-artist-tags d-flex flex-wrap gap-1 mt-2"></div>
                <div class="track-artist-inputs"></div>
            `;
            trackContainer.appendChild(newRow);

            selectedReleaseArtists.forEach(artistId => {
                addTrackArtist(newRow, artistId);
            });

            updateRemoveButtons();
        });

        trackContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-track')) {
                e.target.closest('.track-row').remove();
                reindexTracks();
                updateRemoveButtons();
            }
            if (e.target.classList.contains('add-track-artist-btn')) {
                const trackRow = e.target.closest('.track-row');
                const select = trackRow.querySelector('.track-artist-select');
                addTrackArtist(trackRow, select.value);
            }
        });

        // Auto-add track artist when selecting from dropdown
        trackContainer.addEventListener('change', function(e) {
            if (e.target.classList.contains('track-artist-select')) {
                const trackRow = e.target.closest('.track-row');
                addTrackArtist(trackRow, e.target.value);
            }
        });
    });
    </script>

    <!-- Edit Label Modal -->
    <div class="modal fade" id="editLabelModal" tabindex="-1" aria-labelledby="editLabelModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/labels/{labelId}(labelId=${id})}" method="post">
                    <input type="hidden" name="_method" value="put">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editLabelModalLabel">Edit Label</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="labelName" class="form-label">Label Name</label>
                            <input type="text" class="form-control" id="labelName" name="labelName" th:value="${name}" required>
                        </div>
                        <div class="mb-3">
                            <label for="ownerName" class="form-label">Owner</label>
                            <input type="text" class="form-control" id="ownerName" name="ownerName" th:value="${owner?.name}">
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" th:value="${email}">
                        </div>
                        <div class="mb-3">
                            <label for="website" class="form-label">Website</label>
                            <input type="url" class="form-control" id="website" name="website" th:value="${website}">
                        </div>
                        <hr>
                        <h6>Address</h6>
                        <div class="mb-3">
                            <label for="street" class="form-label">Street</label>
                            <input type="text" class="form-control" id="street" name="street" th:value="${address?.street}">
                        </div>
                        <div class="mb-3">
                            <label for="street2" class="form-label">Street 2</label>
                            <input type="text" class="form-control" id="street2" name="street2" th:value="${address?.street2}">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city" th:value="${address?.city}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="postalCode" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="postalCode" name="postalCode" th:value="${address?.postalCode}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="country" class="form-label">Country</label>
                            <input type="text" class="form-control" id="country" name="country" th:value="${address?.country}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</main>
</html>
